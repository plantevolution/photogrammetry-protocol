[["index.html", "Flower photogrammetry and 3D modeling protocol 1 About 1.1 Citation 1.2 Contributing 1.3 Disclaimer", " Flower photogrammetry and 3D modeling protocol Marion Leménager Jérôme Burkiewicz Daniel Schoen Diana Constanza Diaz Cardona Simon Joly 2022-09-19 1 About This protocol is an evolving protocol used in the Joly lab at the Université de Montréal (Canada) This protocol describes how to obtain three-dimensional (3D) reconstructions of flowers using photogrammetry. It describes in details the set-up, settings and steps that has worked for us for building accurate flower models, but other approaches are certainly possible. Hence, we hope this protocol serves as a starting point rather than a final protocol. We welcome any comments. 1.1 Citation Leménager, M., J. Burkiewicz, D. J. Schoen, S. Joly. Studying flowers in 3D using photogrammetry. New Phytologist. Accepted pending minor revisions. 1.2 Contributing This protocol was produced with bookdown and is hosted on github. Please do not hesitate to fork the protocol, modify it and make pull requests to improve it! 1.3 Disclaimer We provide this protocol as guidelines, without any guaranty. It has worked well for us for many types of flowers, but there is no guaranty that it will work on all flowers. "],["materials.html", "2 Materials 2.1 Lighting 2.2 Turn table 2.3 Camera 2.4 Color chart 2.5 Softwares 2.6 Flowers 2.7 Summary of materials and software", " 2 Materials 2.1 Lighting It is important to have good lighting conditions to take the photographs. To optimize the lighting conditions, we use a Neewer portable lighting box to recreate lighting studio conditions and reduce shading on the object to a maximum. This lightbox needs to be powered from an outlet or from an external battery. The color of the background used should contrast with the color of the flowers to be photographed. 2.2 Turn table We use an automated turntable and shutter release device (Syrp Genie mini II and turntable) to rotate each flower on itself (360) and trigger a predetermined number of pictures from the camera to get pictures from all around the flower. The genie mini II has several hours of autonomy according to its use, but it can be plugged in a source of energy during the process (external battery, plug, or usb). This device is easily controlled and set remotely via its application \"Syrp\" (Figure 2.1) on any kind of smartphone by Bluetooth (Appstore or Playstore) after the device has been paired with your phone and after any updates suggested by the device has been done. We also use a 1cm scale placed adjacently to the flower, and include a label describing the species name, collection number, date of collection, location, and coordinates. Figure 2.1: Syrp application 2.3 Camera It is important to have very sharp pictures for optimal model construction. However, a professional camera is not necessary. We obtained good results with a Canon T2i/550D camera that shoots 18.0 MP RAW photos (5184 x 3456 pixels). We recommend a fixed macro lens (we use a 60mm fixed Canon lens). Avoid using a lens that isn’t fixed : zooming in and out can create artifacts during the model reconstruction. Ideally the flower should take a large portion of the photographs for best results. We also use a flexible short tripod to support the camera and easily modify the angle at which we take each series of photos. 2.4 Color chart To calibrate the photos for color, we use a Xrite ColorChecker Passport Photo 2. The main target that we use is the classic target with a 24-patch color reference target to create Digital Negative (DNG) ((Adobe2012DNG?)) camera profiles from a raw photo (called DNG conversion), and the 75% neutral gray patch to calibrate for light exposure. Figure 2.2: Xrite color chart details for standard Red Green and Blue (sRGB) values. The 75% neutral gray has values of 0.33 (85/255) for Red Green Blue channels in the LightRoom software 2.5 Softwares To convert RAW photos (CR2 for Canon Raw Version 2 image files) to DNG files, we either use directly Adobe Lightroom Classic to export in DNG format the CR2 photos or Adobe DNG converter. To calibrate the photos according to the color chart, we use the Xrite Color Checker software to create DCP camera profiles from DNG files, and Adobe Lightroom to use these profiles and apply them on an entire set of photos that need the same calibration. To reconstruct the 3D models from photos, we use Agisoft Metashape. 2.6 Flowers Collect fresh flowers from the plant, label them and store them in a cool place or with the tip of the peduncle in some water to prevent accelerated wilting. Different flowers will wilt at different paces. Flowers are pinned through the floral receptacle or peduncle using entomological pins in dense foam at the center of the turntable. Alternatively, flowers can be secured in a truncated pipette tip, itself fixed on the turntable, or with alligator clips to rapidly fix the flowers. Store flowers in 50mL Eppendorf tubes or in foam box no more than an hour before taking photos of them. In some cases, it is necessary to remove sepals from the flower before building the model to accurately study the corolla shape. To do this, use a razor blade and mark the sepal intersections with a waterproof pen. The marks will help for the model construction and more importantly landmarks positioning. 2.7 Summary of materials and software L5cm|L9cm|C1.7cm &amp; &amp; Camera &amp; Digital Single-Lens Reflex (DSLR) (e.g. Canon t2i) &amp; from $500 Macro lens &amp; A preferably fixed lens (e.g. Canon 60mm f/2.8 Macro lens) &amp; from $400 Tripod &amp; Preferably flexible, such as a gorillapod &amp; e.g. $80 Stepping motor and turntable kit &amp; Genie mini II, Shoot smooth rotating video and interactive 360\\({^\\circ}\\) images of objects. Full iOS and Android App control via Bluetooth. Battery life: 6hrs video and 15hrs time-lapse. Panning payload 8.8lbs/4kgs &amp; $328.00 Lightbox &amp; A portable photo studio, e.g. Neewer 20\"/50cm foldable portable photography lighting kit (Neewer Technology Co. LTD, Shenzhen, China), adjustable brightness with 120 LED lights, CRI (colour Rendering Index) of 85+, 6000-6500K colour temperature, needs to be powered by a portable battery in the field, white, grey, and black backdrops. In the bracket of light intensities possible for this lightbox, we used an intermediate light intensity. \\[maximum;usually used; minimum\\] lux light intensities correspond to \\[3140;2680;1330\\] lux for a white backdrop and \\[330;305;238\\] Lux with a black backdrop. &amp; $79.99 External battery &amp; Powering source for in-field photo capture, essentially for the lightbox or to recharge batteries &amp; optional Flower &amp; Freshly cut flower with peduncle and floral receptacle &amp; / Labels and container &amp; Identification and storage of fresh flowers to avoid damage and avoid wilting &amp; / Turntable labels &amp; Identification to species, collector, collection number, date, locality, and coordinates, and the chunk number. To use as a separate photo before each run of photos. &amp; / Razor blade &amp; To remove sepals &amp; / Small block of dense foam &amp; To fix flowers in place with a pin at the center of the turntable. &amp; / Entomological pins &amp; To pin through the peduncle or floral receptacle and fix the flower on the turntable. &amp; / Scale &amp; A 1 cm scale as reference &amp; / Color chart &amp; A color reference to calibrate RAW photos (e.g. X-rite ColorChecker Passport) &amp; e.g. $99.00 Color calibration software &amp; ColorChecker Camera Calibration, Xrite software for automatic color profile creation &amp; Free Photo editing software &amp; Adobe Photoshop Lightroom, editing software for image color calibration in batch &amp; Payment plans vary DNG conversion software &amp; Adobe DNG converter, to convert Camera Raw files from supported cameras to the more widely used DNG raw files &amp; Free 3D reconstruction from photogrammetry software &amp; Agisoft Metashape Pro Software &amp; $549 Academic price "],["settings-and-preparation.html", "3 Settings and preparation 3.1 Camera and tripod settings and preparation 3.2 Turn table settings and preparation 3.3 Summary of settings", " 3 Settings and preparation 3.1 Camera and tripod settings and preparation To obtain the best picture quality for model reconstruction, we need an optimal combination of the light sensibility of the sensor (ISO), the duration of exposure and the focal of the objective (F). As mentioned, it is preferable to use a fixed lens (one that doesn’t allow zooming) to facilitate the model reconstruction in the processing step because the software can’t take zooming into account in the reconstruction process. Maximizing the light source allows us to use the lowest ISO to get crisper images. Adapted time exposure to allow the right amount of light to go to the sensor, avoids low key nor high key photo (under/over exposed photo). This may be adapted according to the subject (light or dark colored subject or background) or if different lighting conditions are used. To maximize the depth of field without lowering the image quality, using the manual option on the camera dial, the focal F should be set to F16. Use the manual focus setting on the side of the lens (Figure 3.1) to avoid camera trigger malfunction when the flowers doesn’t land on the detector. If the flower is off centered during rotation, and the automatic focus can’t focus (on the background) the camera trigger is prevented with the automatic focus. On manual, the camera will always be triggered by the turn table, even if the focus isn’t optimal. Because the subject is moving and may be off centered on the turntable, the focus may need to be adapted while the turn table runs. For this you can pause the turntable, manually adjust the focus, and resume the spin. Figure 3.1: Camera and lens used to take RAW photos. The red arrows (from top to bottom) depict the button to get manual focus, the ISO button and the manual parameter on the camera dial. A flexible tripod (Figure 3.2) is used to adjust several camera heights, high, middle, and low, close to the subject. Figure 3.2: Flexible tripod used to adjust camera positions. 3.1.1 Camera settings The standard settings have to be adjusted depending on the flower (colour mostly and conditions). We often use the following settings : exposure time (shutter speed) 1/20s, F/16 focal, ISO 100, standard exposition on the light meter, and we save pictures as RAW files (ML setting on the camera display) format to be able to post-process them for color calibration (Figure 3.3). A RAW photo of the color chart with an identical set of lighting conditions and camera settings as the flower to be photographed is needed for each flower photos series. If several flowers are processed one after the other without variation of light conditions, only one chart photo is needed. The nicer and the sharper the photographs, the easier it will be to build the models. So make sure that the flower is always in focus. Shade or high light reflectance can also impair model reconstruction, so pay attention to these while taking the pictures. Figure 3.3: Camera settings interface of the Canon t2i/550D. 3.1.2 Optional : custom camera white balance Optionally, you can begin by setting a personalized white balance (WB) in your camera with the light gray scale on the chart : For a Canon camera, take a picture of the gray scale; Choose Custom WB in your camera settings (Figure 3.4); Select Custom and use the picture of the grey scale to define your custome white balance (Figure 3.5). Be careful, you will still require to linearize and calibrate each photo afterwards. However, the color chart will always be the reference for post-processing the color calibration of each photo. This optional section only helps to have a better preview of the photos. Figure 3.4: Custom whhite balance parameter. Figure 3.5: How to select a custom white balance. 3.2 Turn table settings and preparation For each run (one 360 spin of the turn table), we use a wait time of 2s to allow the camera time to save the images on the SD card after it is triggered, and the flower to stabilize after each rotation. Connect the shutter release to your camera and the turntable Syrp Genie II (Figure 3.6). Turn the turntable on (to turn it off, hold the on button for 3 seconds). Connect the Syrp Genie II to your device, and do the updates if required (needs an internet connection). Click on create content &gt; turntable (Figures 3.7, 3.8). Make sure the turntable orientation is inverted in the detailed settings (Figure 3.9) In parameters (Figure 3.10), select 20 photos for each run, and 2s of waiting (move-wait-shoot-wait-move). If it is too quick, some pictures won’t be able to be saved as the camera needs a delay to save them on the memory card. The spinning device will take the first picture then proceed to a move-shoot-move run until the last photo. Place the white background circle on the turntable to contrast with the flower. If your flower is pale, then use a different background (colored or darker). Ideally, the color of the circle should be the exact same color of the background of the lightbox as this will help when applying masks later. Figure 3.6: Camera shutter release port. Figure 3.7: Camera shutter release port. Figure 3.8: Camera shutter release port. Figure 3.9: Genie detailed settings. Figure 3.10: Start recording with the turntable. 3.3 Summary of settings L4cm|L12cm Parameter &amp; Description Aperture &amp; F/16 Sensibility &amp; ISO 100 (lowest) Exposure time &amp; 1/20s - Can be adapted according to the flower. Reminder : a photo of the color chart in the exact same light conditions and camera parameters as the flower needs to be taken. Number of photos &amp; 20 per 360 for one camera position and one flower position. May be adjusted according to each flower. Wait time &amp; 2s "],["image-capture-step-by-step.html", "4 Image capture step-by-step 4.1 Take a picture of the color chart 4.2 Flower placement &amp; Image capture", " 4 Image capture step-by-step 4.1 Take a picture of the color chart Set the camera settings to F/16, ISO 100, 1/20s, and RAW format. Verify that you have enough space on your SD card for RAW photos (a minimum of 163 photos, accounting for photos of labels and chart). Verify that the placement of your turntable inside the lightbox will allow to capture correctly the flower you are about to photograph (distance from opening of the lightbox) and that the 1/20s shutter speed captures enough light from your flower by taking an initial photo of your flower. If satisfactory go to next step. The goal here is to have a definite set of settings that will match both your flower photos and a color chart to subsequently calibrate all your photos that have the same light conditions and camera settings. Place the color chart where the flower will be placed, without shadows, and exposed under the same light as the flower will be (angled towards the LED source light in the lightbox). The camera settings and lighting cannot be changed after this. If the lighting or the camera settings are modified, the color chart needs to be taken again to correct the corresponding photos. Place the camera so that the entire chart is visible. Take a picture of the color chart (RAW). Make sure to Incorporate each color squares, and the corners of the chart as follows (Figure 4.1). Figure 4.1: Colour chart photo taken at the beginning of the process to calibrate the photos in post process. 4.2 Flower placement &amp; Image capture To reconstruct an accurate 3D model, it is very important to have pictures of all the parts and details of the flowers and from several angles. Also, the photographs need to overlap with each other for proper alignment in the first steps of the reconstruction. For this reason, several pictures will be taken of each flower: from different orientation and all around the flower. We suggest that flowers should be photographed from at least two positions (e.g., Figure 4.2). For more complex flowers, three positions may be required: horizontal, vertical, and upside down (Figure 4.3). Note that it is better to take more photos than less because if we can drop some pictures during the model reconstruction, it is impossible to come back and take more pictures if we realize that we should have taken more. Figure 4.2: Two flower positions that are normally suficient for Gesneriaceae flowers. Figure 4.3: More complex flowers can require the pictures to be taken from three flower positions. For Gesneriaceae, we first suggest a standard orientation and an upside-down position (Figure 4.2) of the flower as this generally gives satisfactory results . For more complex flowers, three positions may be required: horizontal, vertical, and upside down (Figure 4.3). Clip the camera on the flexible tripod (gorillapod) and place the camera at one of the three position required per flower position : high mid, and low position (see Figure 4.4. Make sure to not use different camera orientations (landscape vs. portrait). If sepals need to be removed, use a razor blade to cut them at the base and mark the sepal intersections with a waterproof pen to keep track of the morphological structures. Pin the flower through the peduncle or the floral receptacle and through a block of dense foam or malleable gum. You can use several pins to avoid any sliding of the flower during the image capture process. Make sure to place the flower so that the whole flower will be encompassed in the camera frame as much as possible. It is best to have the subject to take the most place as possible in the camera frame to capture every details overall than having it entirely in the camera frame but with poor detail quality. What counts the most is to get several overlapping photos for each features. Make sure that the flower is not in contact with anything as this would deform the flower and create problems during the model reconstruction. For flowers with very uniform color or with radial symmetry, it may be important to place dots with a waterproof pen on the corolla to facilitate manual marker positioning and/or automated pixel position detection in the reconstruction step. Place a scale (e.g., 1 cm) directly below the flower. Take a picture of the flower with the label for each new positioning of the flower. This will help to identify each group of images in the following model construction. Press the rec button on your smartphone using the turntable interface to start the spin of the turntable and automated image capture. Verify occasionally the focus on the flower while the flower rotates by pressing the square button (stop) and manually adjust the focus if needed, then press rec to resume your spin. Figure 4.4: The three camera positions from which pictures should be taken for each flower position. Adjust the number of flower positions and number of photos according to each flower. For intricate flowers, or flowers that can’t be captured entirely with only two positions (ventral and dorsal), you can place the flower on an another position (Figure 4.3). On the contrary, if the flower can’t be placed on several positions, you may need to increase the number of photos per camera height in order to have sufficient information for the software to reconstruct accurate 3D models. "],["image-post-processing.html", "5 Image post processing 5.1 File names and storage 5.2 Image color calibration", " 5 Image post processing 5.1 File names and storage We found that it is critical to have a very organized structure for saving files, especially when several persons are working on the same project. We propose here what has been working so far for us. In a species folder named with the name of the species (Genus_species), there should be a distinct folder for each individual photographed, usually with a different collection number. If the same individual has been photographed several times, the date of photos acquisition should be appended to the folder name to discriminate them. We also indicate with the folder name if the individual has been photographed with or without sepals. For each flower, we have one folder for uncalibrated photos, one for calibrated photos, and one for the model. The picture of the color chart should be placed in the uncalibrated photos. To distinguish which photo goes in which chunk, a photo of the label is taken at the beginning of each chunk (each set of photo per side of flower). We suggest to place the photos from different chunks in different folders, once the photos are calibrated. The date of when the photos are taken is important because it helps matching the calibration to the right DNG file. If more than one set of photos with different lighting or camera settings are taken, make sure to distinguish the color charts that correspond to each set of photos. Genus_species GEN_species_CollectionNumber sepal_DD.MM.YYYY or no_sepals_DD.MM.YYYY Model MetashapeProject MetashapeProjectFolder.files model.obj model.ply texture.jpg Photos calibrated Place here all the calibrated photos, that you can organize per chunk Photos to calibrate Place here all the RAW photos and color chart 5.2 Image color calibration 5.2.1 Creating color profiles We present here three ways to create camera profiles. The first one allows to manually check the automatic detection of the color chart, the second and third ones are fully automatic (on MacOS and windows respectively). This does not linearize the photos. For further details on color calibration read (troscianko2015image?). Method 1 : Manual creation of color profiles Get the Xrite ColorChecker Camera Calibration software and Adobe DNG converter software. Create a new empty folder called DNG. Copy the RAW file representing your color chart in your DNG folder, and rename it accordingly (e.g. Color_chart_DD.MM.YYYY). Open DNG converter and select the DNG folder we created for the first box. You need to select a folder, and can’t select a specific file, the software will convert all the files within this folder. Default parameters are ok for step 2-4. It will export the RAW file in the DNG folder to a DNG file with the same file name (Figure 15). Open the Color Checker Camera Calibration software and drag and drop the newly created DNG file in the software. The software will automatically draw a grid around it. Make sure that the green grid fits the chart, avoiding edge effects on each square of color (Figure 16). Click on create profile and save it under Color_Chart_DD.MM.YYYY (Figure 17). Convert RAW chart to DNG in Adobe DNG Converter Align grid on chart in ColorChecker Camera Calibration Export the color profile Image color calibration workflow Method 2 : X-Rite Color Checker plug-in installation and automatic creation of color profiles on MacOS Directly in Adobe Lightroom, you can add ColorChecker Camera Calibration as a module to a means of exporting files directly into a color profile. Click on File &gt; Export &gt; Plug-in Manager (or gestionnaire des modules externes in the left bottom corner) Click on Add Navigate to Library &gt; Application Support &gt; Adobe &gt; Lightroom &gt; Modules Select XRiteColorCheckerPassport.lrplugin and then click on Add Plug-in and done. Click on the color chart then File &gt; Export &gt; Choose Xrite presets from the drop down menu. Name your profile then &gt; Export It will go through ColorCheckerCamera calibration to automatically create the profile. Restart Lightroom as indicated. Method 3 : X-Rite Color Checker plug-in installation and automatic creation of color profiles on Windows Get the Xrite ColorChecker Camera Calibration software and download the PC Version. Save the CameraCalibrationSetup.exe in your downloads, for example, and run the program. If Adobe Lightroom Classic is already installed on your computer, the installation program should proposed you to install the Adobe Photoshop Lightroom plug-in (Figure 19). Install it. Once the plug-in is installed, run Adobe Lightroom Classic and import your color chart (File &gt; Import). Click on File &gt; Export and in the drop-down menu, select X-Rite Preselection (Figure 20). Name your profile, and click on Export. Restart Lightroom as indicated. Run the setps 4 and 5 each time you want to create a new color profile witht the color chart. Color Checker plug-in for Lightroom installation Color chart profile exportation 5.2.2 Color and illuminance calibration from profiles Import your photos in Lightroom Classic. File &gt; Import then select your folder of RAW photos. Select the tab development. Select the photo of the chart Select the color profile corresponding to the color chart you have selected (see Figure \\[color profile\\] to manually add a color profile) to calibrate the photo of the chart with its own calibration profile. Add a new color profile After adding a profile with the + sign, select it in the list below. Use the eyedropper over the 75% gray scale (the last one before the black chip on the color chart, see Figure 2). Do not click on the photo with the eye dropper, only hover over the photo. Select the exposition setting, and adjust the values the eyedropper indicates of the gray scale using the exposition setting to obtain the RGB values of the closest values to 0.33 0.33 0.33 (corresponding to 85/255 for each of the red, blue, and green class). The illuminance is now adjusted in addition to the color calibration, but only on the chart. To apply the modifications we just did to all the photos, select all the photos (Cmd+A or Ctrl+A), and make sure that the one for which you made changes is highlighted (in white compared to light gray for the other ones selected) (see Figure 23). Check the profiles and exposure boxes before synchronizing to all the other photos. Click on the button synchronize. Synchronize your settings made to the photo of the chart to all the other photos and check the two categories you modified (color profile and exposure). 5.2.3 Export calibrated files to jpg format Select all the photos you need to export or all of them (cmd+A or windows+A) Click on File &gt; Export You can create presets that you will only need to create once to always export the same way in Adobe Lightroom (example Figure 24), and add personalized file names such as _color_calibrated at the end of each .jpg file (see also for that Figure 24). In their own folder, you can then sort the calibrated photos for color and exposure per chunks (easily distinguishable by the separation created by a photo of the label). You can export using your own personalized parameters and then export in batch your selection in a specific folder within your folder of uncalibrated photos for easy access. This method can thus work for any folder of uncalibrated photos. "],["d-model-reconstruction-in-agisoft-metashape.html", "6 3D model reconstruction in Agisoft Metashape 6.1 Download Agisoft Metashape 6.2 Initial tweaks 6.3 Overview of the model building pipeline 6.4 Photo importation 6.5 Mask application 6.6 Masks touch ups 6.7 Camera alignment 6.8 Align chunks together 6.9 Merge chunks 6.10 Build 3D mesh 6.11 3D mesh touch ups 6.12 Build texture 6.13 Scaling 6.14 Model orientation 6.15 Export model and texture", " 6 3D model reconstruction in Agisoft Metashape 6.1 Download Agisoft Metashape Download the Agisoft Metashape professional edition software here. Make sure that your computer fills the minimum system requirements. The standard edition doesn’t allow the use of the scale option that we will need to add a scale on our models. Agisoft Metashape 6.2 Initial tweaks Agisoft Metashape can use graphic cards at certain steps of the model construction such as image matching and depth maps calculation. To enable the use of the graphic hardware (GPU): Select Preferences command from the Tools menu. In Preferences dialog select GPU tab. Select available GPU devices in GPU tab of the Preferences window This step has to be done only once. This protocol has been elaborated using the version 1.7.1 of Agisoft Metashape. The latest version of Metashape is now version 1.8.2, but we still made the following changes. In order to obtain accurate thin structures, such as petal margin, and avoid holes in your mesh in Agisoft Metashape 1.5.x or later (up to our knowlege) you will need to activate ONCE the Visibility consistent mesh function in Tools &gt; Preferences &gt; Advanced &gt;Tweaks, then Add and fill in Parameters with BuildModel/tvl1_mesh and select the value as False (figure \\[metashape_tweaks\\]). Additionally, to use the anterior version of the depth maps generation process, add ONCE the tweak : BuildDepthMaps/pm_enable and set the value to False (figure \\[metashape_tweaks\\]). 6.3 Overview of the model building pipeline To build a model, we need to do the following steps: 1) Import the calibrated photos, 2) apply masks to remove background on the photos, 3) align the cameras, 4) calculate depth maps, 5) build the 3D model (mesh), and 6) reconstruct the final texture (model color). There could be different approaches for each of the steps and options will be given below. One important note is whether all the pictures (cameras) are aligned simultaneously of if it is necessary to proceed by groups of pictures that correspond to each flower positions. The first approach is quicker and normally results in more accurate models. However, it does not work all the times. We recommend to try it first and if it fails to use the alternative approach, which is to divide the pictures in different \"chunks\" that will create partial 3D models. 6.4 Photo importation Go to Workflow, click on Add Photos, and click Open. Once the photos are imported, they are in a single \"chunk\", which is a group of photos. To try to align all the photos simultaneously (ideal approach), you need to arrange them in \"camera groups\", where each camera group contains all pictures taken with the same flower orientation. Once this is done, you can add the first photo of each set of photos representing the label, and right click on this photo and select disable cameras. This allows you to not take it into account while reconstructing the model, but to keep all the information about the flower in your Metashape project. 6.5 Mask application Masks represent selected areas that are excluded from the feature detection procedure when applied to key points detection. When several keypoints are detected as the same point (matched as projections of the same 3D point on different photos), then it is considered as a tie point. If masks are applied to tie points, then if a key point is masked in at least one image, it will not be considered. You can thus use a single or just a few masks with the second method (apply masks to tie points). It is however possible to automatically apply masks on each photo to better constrain key point detection (apply masks to keypoints). Using masks helps in removing points to be detected in the background during image alignment procedure. You can see examples here on the Agisoft helpdesk portal. Step-by-step mask application workflow Duplicate one of your photos, and fill it in black in any image manipulation software, and rename it as background.jpg. You can also take a picture of the lightbox without your flower just before starting to shoot and use this image as background. This sometimes work better. Right click on a photo in one of your chunk in your Metashape project. Click on Masks, Import Masks and in the box that appears select method \"From Background\", operation Replacement. Enter the same name as the name of your background you just saved. Depending on the flower, the value for Tolerance can vary between approximately 40 and 60. For some pale flowers you may need a lower tolerance value (e.g. 30). Test different values of tolerance on a single photo first, but when you have a value that is satisfactory (that create a masks with the border of the flower well defined) you can select Apply to entire workspace Click OK This will automatically produce masks around the flowers for all the photos in all your chunks. This is why we need a contrasting white background behind the flower. Check for masks that need touch ups (next section). Right click on an image to select a mask to import. Import mask from a black image background.jpg, and select a tolerance value, to test on the selected camera (the image you right-clicked on). If the automatic mask is automatically well adjusted around the flower shape (darker gray around the flower), then apply to entire workspace (all the images). Alternative masking method using Adobe Photoshop It is also possible to use Adobe Photoshop to apply masks. We did not find particular improvements compared to the Agisoft Metashape approach. Go to the file containing the pictures of chunk 1. Copy and paste this file, naming it accordingly (e.g. Chunk1-Background). Go to Adobe Photoshop version 19.1 and up. Make a copy of all of the photos you’ll be using and place them in a new folder labeled Chunk1-masks. Then, you will need to create ONCE a Photoshop action, that will be subsequently reused (see figures below) : Record a new action called Automatic Mask - 3D reconstruction When you reopen your photo, don’t forget to remove this extra task in your action. The action should include Select Subject, Fill, Inverse, Fill, Save, Close, and you can batch process this action to a specific folder of copied photos to create masks. Apply the action to the folder of copied photos called Chunk1-masks. Now you should have tranformed all your copied photos into masks, with the foreground object in white, and the background in black. Go to Agisoft Metashape and right click on the first camera (photo) of chunk 1. Click on Masks &gt; Import Masks and in the box that appears select method From file, operation Replacement. In Filename Template use filename.jpg. Select Apply to all cameras and then click OK. Check the masks for touch ups. 6.6 Masks touch ups The automatic application of masks at the previous steps is sometimes not entirely satisfactory for all photos. It is possible to add or remove parts of masks using the selection tool and the add/remove/invert buttons (Figure 25). You can then use the selection tools to select areas that are not the flower and add the selection to the mask (Figure 25). You also remove the scale and the entomological pin at this step. Additionally, you can invert the selection, or remove the selected areas from the mask with the icons on the right hand side of the add to mask icon. Selection tools and add selection to mask tool 6.7 Camera alignment Click on the chunk you want to align, which could comprise several camera groups. Make sure to disable photos you don’t want (the label photo, and blurry photos) and that the masks are clean. Go to Workflow, Align Photos and put the accuracy on High or Very high. In the section Advanced, check Generic pre-selection, and select Apply masks to key points, and click OK. Note that if you have applied the masks to only some photos, select Apply masks to tie points. If you are aligning several chunks of photos, it is possible to run this job in batch for each chunk in workflow &gt; batch process &gt; Add button &gt; select the job type as Align photos to apply to all chunks or select specific ones &gt; add parameters listed above (Figure 26). Align photos in multiple chunks Optional: align using markers If the different camera cannot align properly, it is possible to place homologous markers on the flower, defined as remarkable points on the flower (distinguishable pattern such as color dots on the corolla, for example), or by little pen marks at the surface of the flower when homologous markers lacks. These points need to be clearly identifiable on all camera groups. You will need at least 5 markers per flower, ideally positioned in different regions of the flower (e.g., near the peduncle, sepals tips, petals). Do not use points from the background to align chunks as it is independent from the flower (the flower changes position relative to the background). Right click on the picture Then click on Place Marker &gt; New Marker. In the left panel, rename them accordingly. Make sure to use the same nomenclature on each chunk to be able to merge them according to their names. To help the software recognize the markers, spread the manual markers on photos throughout the chunk (It is normally sufficient to place it on 2-3 photos and the software normally places them properly on the others, but make sure the markers are all properly placed). Repeat the step for each marker and each chunk. Select one chunk. Go to Workflow &gt; Align Chunks, select the chunks you want to align, set the method as Markers based and then click OK. Repeat for all chunks to align. Optional If the camera alignment is not satisfactory, it is possible to clean the tie point obtained and try to realign the cameras. For instance, on the tie point generated by the alignment, you can delete outlier and imprecise points (Figure \\[removing_points\\]): In the top menu, click on Model and then Gradual Selection. Select Reconstruction uncertainty on Criterion and play with the Level value to remove the uncertain points. The higher the value, the worst is the point placed. Values between 30 and 10 generally give good results. Then OK. Press Delete on your keyboard to delete the selected points in red. You don’t need much more than 10,000 points for good photo alignments. After removing uncertain points, go to the Reference panel and click on Optimize Camera to optimize camera position. Select all of the cameras. In Model &gt; Gradual Selection, ensure that Reprojection error parameter is below 1. If it is not, check if the alignment runs well (camera needs to form a full circle above the object). If the alignment fails, try to re-align photos by following step 3 (don’t forget to check the box \"reset current alignment\"). If the alignment didn’t fail, go to Model &gt; Gradual Selection &gt; Reproduction error, and set the level to 1 and click OK. Then press Delete. Manually remove remaining outliers using the selection tool. Repeat these steps for each chunk. Use the selection tool to remove background points Use the gradual selection tool to remove additional mis-calculated points Note: If the alignment fails using only one chunk and two or more camera groups, then it will be necessary to divide your job in several chunks. Each chunk should then contain photos from one flower position. Once the chunks are ready, you can proceed with the alignment following the previous steps. 6.8 Align chunks together Note: This step is only necessary if your project is divided in several chunks. At this step, it is important to align the different chunks with each other before they can be combined in a complete model. There are two ways to do this. The approach using tie points is quick but does not work all the time. If it fails, you will have to use the approach using markers. To align using tie points : Select the chunks to align together. Go to Workflow &gt; Align Chunks, select the chunks you want to align together, set the method as Point based (Figure 29). Restrict the key points with masks. Click on OK. To align using markers : Place homologous markers on the flower, defined as remarkable points on the flower (distinguishable pattern such as color dots on the corolla, for example), or by little pen marks at the surface of the flower when homologous markers lacks. These points need to be clearly identifiable on all chunks. You will need at least 5 markers per flower, ideally positioned in different regions of the flower (e.g., near the peduncle, sepals tips, petals). Do not use points from the background to align chunks as it is independent from the flower (the flower changes position relative to the background). Right click on the picture Then click on Place Marker &gt; New Marker. In the left panel, rename them accordingly. Make sure to use the same nomenclature on each chunk to be able to merge them according to their names. To help the software recognize the markers, spread the manual markers on photos throughout the chunk (It is normally sufficient to place it on 2-3 photos and the software normally places them properly on the others, but make sure the markers are all properly placed). Repeat the step for each marker and each chunk. Select one chunk. Go to Workflow &gt; Align Chunks, select the chunks you want to align, set the method as Markers based and then click OK. Repeat for all chunks to align. When the chunks are aligned, a \\[T\\] is put at the end of your chunk name to notify that it is transformed. You can check the alignment using the icon to show aligned chunks (icon of layers on top of each others, Figure 30). The different chunks should be well aligned over the whole flower. If the alignment of your chunks is unsatisfactory, try to place more markers on recognizable features and spread across the whole flower. Additionally, you can manually align chunks using the tools to move the models in the space, but this is highly not recommended. Align chunks Show aligned chunks to verify their positions 6.9 Merge chunks Note: This step is only necessary if your project is divided in several chunks. The next step is to merge chunks together when they are well aligned. Click on Workflow &gt; Merge chunks, and merge using either the tie point method or the markers method depending on the option selected above. 6.10 Build 3D mesh Select the chunk or the merged chunks for which you want to build a 3D mesh (model). Go to Workflow &gt; Build Mesh. In the dialog box, make sure that Source Data is on Depth maps, Quality and Face Count on High (Figure 31). Note that although it is also possible to generate a mesh from a dense point cloud (which has to be built separately), the depth maps provide better results for objects with a high number of minor details. Then go to Advanced, check Calculate vertex colors. Click OK. Once the mesh is produced, you should remove the pin and extra floating background parts using the selection tool. This will highlight the selection in red. Verify your selection and press delete to remove them. Build 3D mesh Our protocol merges the chunks to build a tie point model of all chunks before constructing a model for the merge chunk. We found that this is the best approach, although it is also possible to build models for each chunk separately and then merge these models to obtain a full model. 6.11 3D mesh touch ups You can smooth the mesh by clicking on Tools, Mesh, Smooth Mesh. You can also duplicate a 3D model to save one intact, and right click on it, and un-check Use as default to keep it as an archived model. If you smooth a mesh, you can’t undo it. You can fill holes in your mesh by clicking on Tools &gt; Mesh &gt; Close Holes. Note that if your holes are too big, the closing function can create unwanted structures. Similarly as the smoothing, you can’t undo closing holes in the mesh. HOWEVER, this will remove the vertex colors in version 1.7.2, which we will need to place landmarks when doing the morphometrics. 6.12 Build texture To build the texture : Workflow &gt; Build Texture, use the preset values and click OK. 6.13 Scaling To scale the model, go to the pictures of your merged chunk and follow these steps : On a picture displaying the scale bar, add new markers at each end of the scale bar and on a couple of additional photos. In the left panel, select both markers and click on the icon Add scale (Figure 32). Go to the Reference panel, select the scale and add 0.01 as reference. Click on the Update transform button (rotating arrows). This is an important step, because otherwise the scale will not be incorporated to your model. To verify if the scale is taken into account, you can use the measuring tape tool. Add a scale using landmarks 6.14 Model orientation In Metashape, be sure that Show info in Model &gt; Show/Hide Items is checked. You should see at the bottom right of the model panel the 3D axes. Show grid Make sure that the scale is the right one, changing it will affect the coordinates of the 3D model. You can verify the scale using the measuring tool. Use the navigation tool to orient these 3D axes. Once you orient the 3D axes in the wanted direction, you can then use the tool Rotate Object to put the object in the wanted direction, and at the center of the grid, facing the right side of the grid. Orient the binding box as well with the cross on the ventral side, and the two dash facing the opening of the flower. Note that depending on the software you use to open the model, the first view orientation may change when you open the final object file. 6.15 Export model and texture You can export your 3D model by clicking on File &gt; Export &gt; Export Model. Name your model Choose .ply as the extension. In the dialog box, tick the Vertex colors. This option will allow you to get color on the actual 3D model. Select Export texture as PNG. Make sure to export the texture with transparency, by ticking the Write alpha channel option. The texture is a separate file, with detail color information that is wrapped on the model. Click on OK. "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
